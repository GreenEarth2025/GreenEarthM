<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canberra Family Bill Tracker (Australian FY)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background: #0e1116; color: #e6edf3; font-family: Arial, sans-serif; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 8px; border-bottom: 1px solid #232a34; }
  th { background: #151a22; }
  input, select { padding: 4px; border-radius: 4px; border: 1px solid #232a34; background: #0c1016; color: #e6edf3; }
  .unpaid { color: red; font-weight: bold; }
  .controls { text-align: center; margin: 10px 0; }
  button { padding: 6px 12px; margin: 4px; border-radius: 4px; border: none; background: #2563eb; color: white; cursor: pointer; }
  button:hover { background: #1d4ed8; }
  #stressMeter { text-align: center; padding: 10px; margin-top: 10px; border-radius: 8px; font-weight: bold; }
</style>
</head>
<body>

<h1>Canberra Family Bill Tracker (Australian FY)</h1>
<p style="text-align:center;">Q1 = Jul–Sep, Q2 = Oct–Dec, Q3 = Jan–Mar, Q4 = Apr–Jun</p>

<div class="controls">
  <label>Quarter:
    <select id="quarter">
      <option value="Q1">Q1 (Jul–Sep)</option>
      <option value="Q2">Q2 (Oct–Dec)</option>
      <option value="Q3">Q3 (Jan–Mar)</option>
      <option value="Q4">Q4 (Apr–Jun)</option>
    </select>
  </label>
  <label>Year:
    <select id="year"></select>
  </label>
  <button id="addBill">Add New Bill</button>
  <button id="generatePDF">Generate PDF Summary</button>
</div>

<div id="stressMeter">Bill Stress Meter: Loading...</div>

<table id="billTable">
  <thead>
    <tr>
      <th>Bill</th>
      <th>Avg/Quarter</th>
      <th>Your Amount</th>
      <th>Required?</th>
      <th>Paid?</th>
      <th>Paid Date</th>
      <th>Paid By</th>
      <th>Due Date</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<canvas id="billChart" style="margin-top:20px;"></canvas>

<script>
const DEFAULT_BILLS = [
  { name: "Electricity", avg: 600 }, { name: "Gas", avg: 250 },
  { name: "Water & Sewerage", avg: 240 }, { name: "Council Rates", avg: 800 },
  { name: "Land Tax", avg: 600 }, { name: "Internet / NBN", avg: 240 },
  { name: "Mobile Plans", avg: 360 }, { name: "Streaming Services", avg: 120 },
  { name: "Cloud Storage", avg: 30 }, { name: "Software Subscriptions", avg: 60 },
  { name: "Car Registration", avg: 275 }, { name: "Roadside Assistance", avg: 45 },
  { name: "Car Insurance", avg: 350 }, { name: "Public Transport", avg: 90 },
  { name: "Home & Contents Insurance", avg: 450 }, { name: "Family Health Insurance", avg: 1050 },
  { name: "Life Insurance", avg: 150 }, { name: "Income Protection", avg: 300 },
  { name: "Pet Insurance", avg: 150 }, { name: "Mortgage / Rent", avg: 7500 },
  { name: "Credit Card Payment", avg: 300 }, { name: "Personal Loan", avg: 600 },
  { name: "School Fees", avg: 600 }, { name: "School Activities/Uniforms", avg: 150 },
  { name: "Childcare", avg: 900 }, { name: "Pest Control", avg: 40 },
  { name: "Lawn/Gardening", avg: 120 }, { name: "Home Security Monitoring", avg: 75 },
  { name: "Charitable Donations", avg: 90 }, { name: "Medical/Dental Gap", avg: 200 },
  { name: "Gym/Sports Clubs", avg: 150 }
];

const STORAGE_KEY = "canberra_bills_fy_v5";
let state = loadState();

function initYearSelect() {
  const yearEl = document.getElementById("year");
  const thisYear = new Date().getFullYear();
  for (let y = thisYear - 1; y <= thisYear + 1; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearEl.appendChild(opt);
  }
  yearEl.value = thisYear;
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : {};
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function stateKey(year, quarter) {
  return `${year}_${quarter}`;
}

function ensureQuarterData(year, quarter) {
  const key = stateKey(year, quarter);
  if (!state[key]) {
    state[key] = DEFAULT_BILLS.map(b => ({
      name: b.name, avg: b.avg, amount: b.avg,
      required: true, paid: false, paidDate: "",
      paidBy: "", dueDate: ""
    }));
  }
}

function updateStress(totalPaid, totalAvg) {
  const meter = document.getElementById("stressMeter");
  const pct = totalPaid / totalAvg;
  if (pct < 0.5) { meter.style.background = "#10b981"; meter.textContent = "Bill Stress Meter: Low"; }
  else if (pct < 1) { meter.style.background = "#f59e0b"; meter.textContent = "Bill Stress Meter: Medium"; }
  else { meter.style.background = "#ef4444"; meter.textContent = "Bill Stress Meter: High"; }
}

function renderTable() {
  const year = document.getElementById("year").value;
  const quarter = document.getElementById("quarter").value;
  ensureQuarterData(year, quarter);
  const key = stateKey(year, quarter);
  const tbody = document.querySelector("#billTable tbody");
  tbody.innerHTML = "";
  let totalPaid = 0, totalAvg = 0;
  state[key].forEach((bill) => {
    if (bill.paid) totalPaid += bill.amount;
    if (bill.required) totalAvg += bill.avg;
    const tr = document.createElement("tr");
    if (!bill.paid) tr.classList.add("unpaid");
    tr.innerHTML = `
      <td><input type="text" value="${bill.name}"></td>
      <td><input type="number" value="${bill.avg}"></td>
      <td><input type="number" value="${bill.amount}"></td>
      <td><input type="checkbox" ${bill.required ? "checked" : ""}></td>
      <td><input type="checkbox" ${bill.paid ? "checked" : ""}></td>
      <td><input type="date" value="${bill.paidDate}"></td>
      <td><input type="text" value="${bill.paidBy}"></td>
      <td><input type="date" value="${bill.dueDate}"></td>
    `;
    const inputs = tr.querySelectorAll("input");
    inputs[0].addEvent
