<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>Canberra Family Bill Tracker (Australian FY)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121823;
      --muted: #93a1b3;
      --text: #e6edf3;
      --primary: #5dd3ff;
      --accent: #87ffa3;
      --warn: #ffd66b;
      --danger: #ff7b7b;
      --ok: #7dffa0;
      --info: #74b9ff;
      --grid: rgba(255,255,255,0.08);
      --chip: rgba(255,255,255,0.06);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;

      --cat-housing: #4da3ff;
      --cat-utilities: #ffe066;
      --cat-connectivity: #5dd3ff;
      --cat-insurance: #b084ff;
      --cat-subscriptions: #ff99cc;
      --cat-transport: #ffb366;
      --cat-health: #ff6666;
      --cat-family: #66ff99;
      --cat-other: #cccccc;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #0b0f14;
        --panel: #121823;
        --muted: #93a1b3;
        --text: #e6edf3;
        --grid: rgba(255,255,255,0.08);
        --chip: rgba(255,255,255,0.06);
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(93,211,255,0.10), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(135,255,163,0.08), transparent 55%),
        var(--bg);
    }
    header{
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--grid);
    }
    .wrap{ max-width: 1150px; margin: 0 auto; padding: 18px; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .grow{ flex:1; min-width: 220px; }
    h1{
      margin:0; font-size: 20px; letter-spacing: 0.2px; display:flex; align-items:center; gap:10px;
    }
    .sub{ color: var(--muted); font-weight: 500; }

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
      border-radius: 999px; background: var(--chip); color: var(--muted);
      border: 1px dashed var(--grid);
    }
    select, input[type="date"], input[type="text"], input[type="number"], textarea{
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--grid);
      padding: 10px 12px;
      border-radius: 10px;
      width: 100%;
    }
    .btn{
      background: var(--panel); color: var(--text);
      border: 1px solid var(--grid);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      display:inline-flex; gap:8px; align-items:center;
      transition: transform .06s ease, border-color .2s, background .2s;
    }
    .btn:hover{ border-color: color-mix(in oklab, var(--primary) 55%, var(--grid)); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: color-mix(in oklab, var(--primary) 24%, transparent); border-color: color-mix(in oklab, var(--primary) 60%, var(--grid)); }
    .btn.warn{ background: color-mix(in oklab, var(--warn) 18%, transparent); border-color: color-mix(in oklab, var(--warn) 60%, var(--grid)); color:#000; }
    .btn.ghost{ background: var(--panel); }

    .grid{ display:grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--panel);
      border: 1px solid var(--grid);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card > .h{
      padding: 14px 16px; border-bottom: 1px solid var(--grid);
      display:flex; justify-content: space-between; align-items: center; gap: 12px;
    }
    .card > .b{ padding: 14px 16px; }

    .kpi{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    @media (max-width: 700px){ .kpi{ grid-template-columns: repeat(2, 1fr); } }
    .k{
      background: var(--panel); border: 1px solid var(--grid); border-radius: 12px; padding: 12px;
      display:flex; flex-direction:column; gap:6px; min-height: 86px;
    }
    .k .label{ color: var(--muted); }
    .k .value{ font-size: 20px; font-weight: 700; letter-spacing: .2px; }
    .k.clickable{ cursor: pointer; transition: background .2s, border-color .2s; }
    .k.clickable:hover{ background: var(--chip); border-color: color-mix(in oklab, var(--primary) 55%, var(--grid)); }

    .meter{ display:flex; align-items:center; gap: 16px; }
    .gauge{
      width: 120px; height: 120px; border-radius: 50%;
      background: conic-gradient(var(--ok) 0deg, var(--ok) 90deg, var(--warn) 180deg, var(--danger) 360deg);
      display:grid; place-items:center; position:relative;
      box-shadow: inset 0 0 0 10px rgba(0,0,0,0.06);
    }
    .gauge::after{
      content:""; position:absolute; inset: 10px; border-radius: 50%; background: var(--panel); border: 1px solid var(--grid);
    }
    .needle{
      position: absolute; width: 3px; height: 52px; background: var(--text); transform-origin: bottom center; bottom: 50%; left: calc(50% - 1.5px); border-radius: 3px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));
    }
    .gemoji{ position:absolute; inset: 26px; display:grid; place-items:center; font-size: 28px; z-index: 2; }
    .chip{ padding:6px 10px; border-radius: 999px; background: var(--chip); border: 1px solid var(--grid); }

    table{ width:100%; border-collapse: separate; border-spacing: 0 8px; }
    thead th{
      text-align:left; padding: 6px 8px; color: var(--muted); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px;
    }
    tbody td{
      background: var(--panel); border-top: 1px solid var(--grid); border-bottom: 1px solid var(--grid);
      padding: 10px 10px; vertical-align: middle;
    }
    tbody tr td:first-child{ border-left: 6px solid transparent; border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
    tbody tr td:last-child{ border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
    .right{ text-align:right; }
    .center{ text-align:center; color: var(--muted); }

    /* Category stripes */
    .housing td:first-child{ border-color: var(--cat-housing); }
    .utilities td:first-child{ border-color: var(--cat-utilities); }
    .connectivity td:first-child{ border-color: var(--cat-connectivity); }
    .insurance td:first-child{ border-color: var(--cat-insurance); }
    .subscriptions td:first-child{ border-color: var(--cat-subscriptions); }
    .transport td:first-child{ border-color: var(--cat-transport); }
    .health td:first-child{ border-color: var(--cat-health); }
    .family td:first-child{ border-color: var(--cat-family); }
    .other td:first-child{ border-color: var(--cat-other); }

    /* Status dot */
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .s-paid{ opacity: .9; }
    .status-wrap{ display:flex; gap:6px; align-items:center; }

    /* Modal */
    dialog{
      border: none; padding:0; border-radius: 14px; width: min(720px, calc(100vw - 28px));
      background: var(--panel); color: var(--text); box-shadow: var(--shadow);
    }
    dialog::backdrop{ background: rgba(0,0,0,.4); backdrop-filter: blur(2px); }
    .modal-h{ padding: 14px 16px; border-bottom: 1px solid var(--grid); font-weight: 700; display:flex; align-items:center; justify-content: space-between; }
    .modal-b{ padding: 14px 16px; display:grid; gap:12px; }
    .modal-f{ padding: 12px 16px; border-top: 1px solid var(--grid); display:flex; justify-content: space-between; gap: 10px; }
    .form-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .form-grid-3{ display:grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; }
    @media (max-width: 680px){ .form-grid, .form-grid-3{ grid-template-columns: 1fr; } }
    label{ display:flex; flex-direction:column; gap:8px; }
    .switch{ display:flex; align-items:center; gap: 8px; }

    /* Print summary window (opened separately) inherits dark colors */
    @media print{
      header, .toolbar, dialog { display:none !important; }
      body{ background: var(--bg); color: var(--text); }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="grow">
          <h1>Canberra Family Bill Tracker <span class="sub">(Australian FY)</span></h1>
          <div class="sub">Q1 = Jul‚ÄìSep, Q2 = Oct‚ÄìDec, Q3 = Jan‚ÄìMar, Q4 = Apr‚ÄìJun</div>
        </div>
        <div class="row">
          <label class="pill" title="Financial Year start">
            <span>FY start:</span>
            <select id="fyYear"></select>
          </label>
          <label class="pill" title="Financial Year quarter">
            <span>Quarter:</span>
            <select id="quarter">
              <option value="Q1">Q1 (Jul‚ÄìSep)</option>
              <option value="Q2">Q2 (Oct‚ÄìDec)</option>
              <option value="Q3">Q3 (Jan‚ÄìMar)</option>
              <option value="Q4">Q4 (Apr‚ÄìJun)</option>
              <option value="ALL">All</option>
            </select>
          </label>
          <span class="pill" id="today"></span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px;">
    <div class="toolbar" style="margin-bottom:12px;">
      <button class="btn primary" id="addBtn">‚ûï Add New Bill</button>
      <button class="btn" id="exportBtn">‚¨áÔ∏è Export</button>
      <button class="btn" id="importBtn">‚¨ÜÔ∏è Import</button>
      <button class="btn warn" id="pdfBtn">üñ®Ô∏è Generate PDF Summary</button>
      <span class="pill">Currency: AUD</span>
    </div>

    <section class="grid">
      <div class="card">
        <div class="h">
          <div class="row"><span>Bill Stress Meter</span></div>
        </div>
        <div class="b meter">
          <div class="gauge" aria-label="Stress Meter Gauge">
            <div class="needle" id="needle" style="transform: rotate(0deg);"></div>
            <div class="gemoji" id="mood">üôÇ</div>
          </div>
          <div class="info" style="display:flex; flex-direction:column; gap:6px;">
            <div class="title" id="stressTitle" style="font-weight:700;">Calm</div>
            <div class="sub" id="stressDesc">You‚Äôre in a good place. Keep cruising.</div>
            <div class="row">
              <span class="chip" id="kOverdue">0 overdue</span>
              <span class="chip" id="kSoon">0 due soon</span>
              <span class="chip" id="kThisMonth">0 this month</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h"><span>Category totals (click to filter)</span></div>
        <div class="b">
          <div class="kpi" id="categoryTotals"></div>
          <div id="catFilterHint" class="sub" style="margin-top:8px; display:none;"></div>
        </div>
      </div>
    </section>

    <section style="margin-top: 16px;">
      <div class="card">
        <div class="h">
          <span>Bills</span>
          <div class="row">
            <input type="text" id="search" placeholder="Search bills..." />
            <select id="statusFilter" title="Filter by status">
              <option value="ALL">All statuses</option>
              <option value="OUTSTANDING">Outstanding</option>
              <option value="PAID">Paid</option>
              <option value="OVERDUE">Overdue</option>
              <option value="SOON">Due soon (‚â§14d)</option>
            </select>
            <select id="reqFilter" title="Filter by required">
              <option value="ALL">Required + Optional</option>
              <option value="REQ">Required only</option>
              <option value="OPT">Optional only</option>
            </select>
          </div>
        </div>
        <div class="b" style="overflow:auto;">
          <table id="billTable" aria-label="Bills table">
            <thead>
              <tr>
                <th>Status</th>
                <th>Category</th>
                <th>Bill</th>
                <th class="right">Amount</th>
                <th>Required</th>
                <th>Due date</th>
                <th>Days</th>
                <th>Paid?</th>
                <th>Paid date</th>
                <th>Paid by</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="billBody">
              <tr><td class="center" colspan="11">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div class="b sub">FY starts in July. Q1 Jul‚ÄìSep, Q2 Oct‚ÄìDec, Q3 Jan‚ÄìMar, Q4 Apr‚ÄìJun.</div>
      </div>
    </section>
  </main>

  <!-- Add/Edit Modal -->
  <dialog id="billModal">
    <form method="dialog" id="billForm">
      <div class="modal-h">
        <span id="modalTitle">Add Bill</span>
        <button class="btn ghost" type="button" id="closeModal">‚úñ</button>
      </div>
      <div class="modal-b">
        <div class="form-grid">
          <label>
            <span>Bill name</span>
            <input required type="text" id="fName" placeholder="e.g., Electricity" />
          </label>
          <label>
            <span>Category</span>
            <input required type="text" id="fCategory" list="catList" placeholder="e.g., Utilities" />
            <datalist id="catList"></datalist>
          </label>
        </div>
        <div class="form-grid-3">
          <label>
            <span>Amount (AUD)</span>
            <input required type="number" id="fAmount" min="0" step="0.01" placeholder="0.00"/>
          </label>
          <label>
            <span>Due date</span>
            <input required type="date" id="fDueDate"/>
          </label>
          <label>
            <span>Required?</span>
            <select id="fRequired">
              <option value="true">Yes (essential)</option>
              <option value="false">No (optional)</option>
            </select>
          </label>
        </div>
        <div class="form-grid">
          <label class="switch">
            <input type="checkbox" id="fPaid"/>
            <span>Mark as paid</span>
          </label>
          <label>
            <span>Paid date</span>
            <input type="date" id="fPaidDate"/>
          </label>
        </div>
        <div class="form-grid">
          <label>
            <span>Paid by</span>
            <input type="text" id="fPaidBy" placeholder="e.g., Prakash, Partner"/>
          </label>
          <label>
            <span>Notes</span>
            <input type="text" id="fNotes" placeholder="Optional note"/>
          </label>
        </div>
      </div>
      <div class="modal-f">
        <button class="btn danger" type="button" id="deleteBill" style="display:none;">üóëÔ∏è Delete</button>
        <div>
          <button class="btn" type="button" id="markPaidBtn">‚úÖ Mark paid</button>
          <button class="btn primary" id="saveBill">üíæ Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Import Modal -->
  <dialog id="importModal">
    <div class="modal-h">
      <span>Import bills (JSON)</span>
      <button class="btn ghost" type="button" id="closeImport">‚úñ</button>
    </div>
    <div class="modal-b">
      <textarea id="importText" rows="10" placeholder='Paste exported JSON here'></textarea>
      <div class="sub">This will merge with existing bills. Duplicate IDs are kept only once.</div>
    </div>
    <div class="modal-f">
      <span></span>
      <div>
        <button class="btn primary" id="doImport">Import</button>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmtAUD = v => new Intl.NumberFormat('en-AU', { style:'currency', currency:'AUD', maximumFractionDigits: 2 }).format(Number(v||0));
    const toISO = d => d ? new Date(d).toISOString().slice(0,10) : "";
    const parseNum = v => Number.isFinite(+v) ? +v : 0;
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

    function getFYStartYear(date){
      const d = new Date(date);
      const m = d.getMonth(); // 0..11
      return (m >= 6) ? d.getFullYear() : d.getFullYear() - 1;
    }
    function getQuarter(date){
      const d = new Date(date); const m = d.getMonth();
      if (m>=6 && m<=8) return 'Q1';
      if (m>=9 && m<=11) return 'Q2';
      if (m>=0 && m<=2) return 'Q3';
      return 'Q4';
    }
    function withinSelection(bill, fyYearVal, qVal){
      if (qVal === 'ALL') return getFYStartYear(bill.dueDate) === fyYearVal;
      return getFYStartYear(bill.dueDate) === fyYearVal && getQuarter(bill.dueDate) === qVal;
    }
    function daysFromToday(date){
      const MS=24*60*60*1000;
      const d = new Date(toISO(date));
      const t = new Date(toISO(new Date()));
      return Math.round((d - t)/MS);
    }
    function statusOf(bill){
      if (bill.paid) return 'PAID';
      const days = daysFromToday(bill.dueDate);
      if (days < 0) return 'OVERDUE';
      if (days <= 14) return 'SOON';
      return 'OUTSTANDING';
    }
    function categoryClass(cat){
      const map = {
        'Housing':'housing','Utilities':'utilities','Connectivity':'connectivity',
        'Insurance':'insurance','Subscriptions':'subscriptions','Transport':'transport',
        'Health':'health','Family':'family'
      };
      return map[cat] || 'other';
    }
    function categoryIcon(cat){
      const map = {
        'Housing':'üè†','Utilities':'üí°','Connectivity':'üåê','Insurance':'üõ°Ô∏è',
        'Subscriptions':'üì∫','Transport':'üöó','Health':'‚ù§Ô∏è','Family':'üë®‚Äçüë©‚Äçüëß'
      };
      return map[cat] || 'üì¶';
    }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]); }

    // ---------- Storage ----------
    const KEY='canberra-bills-v4';
    const store = {
      load(){ try { return JSON.parse(localStorage.getItem(KEY)) || { bills: [] }; } catch { return { bills: [] }; } },
      save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }
    };

    // ---------- State ----------
    let data = store.load();
    let currentCatFilter = null;
    let editId = null;

    // Seed dummy data across all quarters and common bill types (only if empty)
    if (!data.bills?.length){
      const baseFY = getFYStartYear(new Date()); // current FY start (July)
      const y0 = baseFY;         // FY start year
      const y1 = baseFY + 1;     // FY end year

      const seed = [
        // Q1: Jul‚ÄìSep (y0)
        { name:'Rent',            category:'Housing',       amount:2300, required:true,  due:new Date(y0,6,1),   notes:'' },
        { name:'Electricity',     category:'Utilities',     amount:210.50,required:true,  due:new Date(y0,6,25),  notes:'Quarterly' },
        { name:'Water',           category:'Utilities',     amount:95.30, required:true,  due:new Date(y0,7,5),   notes:'Quarterly' },
        { name:'Internet',        category:'Connectivity',  amount:79.00, required:true,  due:new Date(y0,6,10),  notes:'Monthly' },
        { name:'Mobile plan',     category:'Connectivity',  amount:45.00, required:true,  due:new Date(y0,7,15),  notes:'Monthly' },
        { name:'Car rego',        category:'Transport',     amount:620.00,required:true,  due:new Date(y0,8,10),  notes:'Annual (ACT)' },
        { name:'Gym',             category:'Health',        amount:35.00, required:false, due:new Date(y0,7,3),   notes:'Weekly draft grouped' },
        { name:'Netflix',         category:'Subscriptions', amount:22.99, required:false, due:new Date(y0,7,12),  notes:'Monthly' },

        // Q2: Oct‚ÄìDec (y0)
        { name:'Rent',            category:'Housing',       amount:2300,  required:true,  due:new Date(y0,9,1),   notes:'' },
        { name:'Gas',             category:'Utilities',     amount:140,   required:true,  due:new Date(y0,9,18),  notes:'Quarterly' },
        { name:'Council rates',   category:'Housing',       amount:550,   required:true,  due:new Date(y0,10,15), notes:'Quarterly' },
        { name:'Internet',        category:'Connectivity',  amount:79,    required:true,  due:new Date(y0,10,10), notes:'Monthly' },
        { name:'Spotify',         category:'Subscriptions', amount:18.99, required:false, due:new Date(y0,11,5),  notes:'Monthly' },
        { name:'Home insurance',  category:'Insurance',     amount:980,   required:true,  due:new Date(y0,11,20), notes:'Annual' },

        // Q3: Jan‚ÄìMar (y1)
        { name:'Rent',            category:'Housing',       amount:2350,  required:true,  due:new Date(y1,0,1),   notes:'Slight increase' },
        { name:'Electricity',     category:'Utilities',     amount:225.4, required:true,  due:new Date(y1,1,1),   notes:'Quarterly' },
        { name:'Water',           category:'Utilities',     amount:90.7,  required:true,  due:new Date(y1,2,3),   notes:'Quarterly' },
        { name:'Internet',        category:'Connectivity',  amount:79,    required:true,  due:new Date(y1,2,10),  notes:'Monthly' },
        { name:'Car insurance',   category:'Insurance',     amount:780,   required:true,  due:new Date(y1,1,14),  notes:'Annual' },
        { name:'Childcare fees',  category:'Family',        amount:420,   required:true,  due:new Date(y1,1,7),   notes:'Fortnightly grouped' },

        // Q4: Apr‚ÄìJun (y1)
        { name:'Rent',            category:'Housing',       amount:2350,  required:true,  due:new Date(y1,3,1),   notes:'' },
        { name:'Gas',             category:'Utilities',     amount:150,   required:true,  due:new Date(y1,4,12),  notes:'Quarterly' },
        { name:'Strata',          category:'Housing',       amount:760,   required:true,  due:new Date(y1,4,20),  notes:'Quarterly' },
        { name:'Health insurance',category:'Insurance',     amount:265,   required:true,  due:new Date(y1,5,2),   notes:'Monthly' },
        { name:'Internet',        category:'Connectivity',  amount:79,    required:true,  due:new Date(y1,5,10),  notes:'Monthly' },
        { name:'Amazon Prime',    category:'Subscriptions', amount:9.99,  required:false, due:new Date(y1,5,15),  notes:'Monthly' }
      ];

      data.bills = seed.map((s, i)=>({
        id: uid(),
        name: s.name,
        category: s.category,
        amount: s.amount,
        required: !!s.required,
        paid: (i % 6 === 0), // mark some as paid
        paidDate: (i % 6 === 0) ? toISO(new Date(s.due.getFullYear(), s.due.getMonth(), Math.max(1, s.due.getDate()-1))) : '',
        paidBy: (i % 6 === 0) ? 'Prakash' : '',
        dueDate: toISO(s.due),
        notes: s.notes || ''
      }));

      store.save(data);
    }

    // ---------- Elements ----------
    const fySel = $('#fyYear');
    const qSel = $('#quarter');
    const todayEl = $('#today');

    const searchEl = $('#search');
    const statusFilter = $('#statusFilter');
    const reqFilter = $('#reqFilter');

    const kOverdue = $('#kOverdue');
    const kSoon = $('#kSoon');
    const kThisMonth = $('#kThisMonth');
    const needle = $('#needle');
    const mood = $('#mood');
    const stressTitle = $('#stressTitle');
    const stressDesc = $('#stressDesc');

    const catTotals = $('#categoryTotals');
    const catFilterHint = $('#catFilterHint');

    const tbody = $('#billBody');

    // Modal
    const modal = $('#billModal');
    const fName = $('#fName');
    const fCategory = $('#fCategory');
    const fAmount = $('#fAmount');
    const fDueDate = $('#fDueDate');
    const fRequired = $('#fRequired');
    const fPaid = $('#fPaid');
    const fPaidDate = $('#fPaidDate');
    const fPaidBy = $('#fPaidBy');
    const fNotes = $('#fNotes');
    const modalTitle = $('#modalTitle');
    const deleteBillBtn = $('#deleteBill');
    const markPaidBtn = $('#markPaidBtn');
    const saveBillBtn = $('#saveBill');
    const closeModalBtn = $('#closeModal');
    const catList = $('#catList');

    // Import modal
    const importModal = $('#importModal');
    const importText = $('#importText');
    const closeImportBtn = $('#closeImport');
    const doImportBtn = $('#doImport');

    // ---------- Init controls ----------
    const yearNow = getFYStartYear(new Date());
    for (let y = yearNow-1; y <= yearNow+2; y++){
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = `FY ${y}‚Äì${String((y+1)%100).padStart(2,'0')}`;
      if (y === yearNow) opt.selected = true;
      fySel.appendChild(opt);
    }
    qSel.value = getQuarter(new Date());
    todayEl.textContent = `Today: ${new Intl.DateTimeFormat('en-AU', {weekday:'short', day:'2-digit', month:'short', year:'numeric'}).format(new Date())}`;

    // ---------- Filtering ----------
    function filtered(){
      const fy = Number(fySel.value);
      const q = qSel.value;
      const txt = (searchEl.value||'').trim().toLowerCase();
      const statusSel = statusFilter.value;
      const reqSel = reqFilter.value;

      return data.bills
        .filter(b => withinSelection(b, fy, q))
        .filter(b => !currentCatFilter || b.category === currentCatFilter)
        .filter(b => {
          if (!txt) return true;
          return [b.name, b.category, b.paidBy, b.notes].some(x => (x||'').toLowerCase().includes(txt));
        })
        .filter(b => {
          const s = statusOf(b);
          if (statusSel === 'ALL') return true;
          if (statusSel === 'OVERDUE') return s === 'OVERDUE';
          if (statusSel === 'SOON') return s === 'SOON';
          if (statusSel === 'PAID') return s === 'PAID';
          if (statusSel === 'OUTSTANDING') return (s === 'SOON' || s === 'OUTSTANDING' || s === 'OVERDUE') && !b.paid;
          return true;
        })
        .filter(b => {
          if (reqSel === 'ALL') return true;
          if (reqSel === 'REQ') return !!b.required;
          if (reqSel === 'OPT') return !b.required;
          return true;
        });
    }

    // ---------- Rendering ----------
    function renderCatList(){
      catList.innerHTML = '';
      const set = new Set(data.bills.map(b => b.category).filter(Boolean));
      Array.from(set).sort().forEach(c => {
        const o = document.createElement('option'); o.value=c; catList.appendChild(o);
      });
    }

    function renderTable(){
      const list = filtered().sort((a,b)=> new Date(a.dueDate) - new Date(b.dueDate));
      tbody.innerHTML = '';
      if (!list.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="center" colspan="11">No bills match your filters.</td>`;
        tbody.appendChild(tr);
        return;
      }
      list.forEach(b=>{
        const s = statusOf(b);
        const days = daysFromToday(b.dueDate);
        const dotColor = s==='PAID' ? 'var(--ok)' : s==='OVERDUE' ? 'var(--danger)' : s==='SOON' ? 'var(--warn)' : 'var(--accent)';
        const tr = document.createElement('tr');
        tr.className = categoryClass(b.category) + (s==='PAID'?' s-paid':'');
        tr.innerHTML = `
          <td><span class="status-wrap"><span class="dot" style="background:${dotColor}"></span>${s}</span></td>
          <td>${categoryIcon(b.category)} ${escapeHTML(b.category||'‚Äî')}</td>
          <td>${escapeHTML(b.name)}</td>
          <td class="right">${fmtAUD(b.amount)}</td>
          <td>${b.required ? 'Yes' : 'No'}</td>
          <td>${toISO(b.dueDate)}</td>
          <td>${days>=0 ? days+'d' : (days+'d')}</td>
          <td>${b.paid ? 'Yes' : 'No'}</td>
          <td>${b.paidDate ? toISO(b.paidDate) : '‚Äî'}</td>
          <td>${escapeHTML(b.paidBy||'‚Äî')}</td>
          <td>
            <button class="btn" data-action="toggle" data-id="${b.id}" title="Toggle paid">${b.paid?'‚Ü©Ô∏è Unpay':'‚úÖ Paid'}</button>
            <button class="btn" data-action="edit" data-id="${b.id}" title="Edit">‚úèÔ∏è</button>
          </td>
        `;
        tr.addEventListener('click', (e)=>{
          if (e.target.closest('button')) return;
          openEdit(b.id);
        });
        tbody.appendChild(tr);
      });
      // Row buttons
      tbody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.currentTarget.dataset.id;
          const act = e.currentTarget.dataset.action;
          if (act === 'toggle'){
            const b = data.bills.find(x=>x.id===id);
            if (!b) return;
            b.paid = !b.paid;
            if (b.paid){ b.paidDate = toISO(new Date()); if (!b.paidBy) b.paidBy = '‚Äî'; }
            store.save(data);
            refreshAll();
          } else if (act === 'edit'){
            openEdit(id);
          }
        });
      });
    }

    function renderCategoryTotals(){
      const { fy, q } = { fy: Number(fySel.value), q: qSel.value };
      const list = data.bills.filter(b=>withinSelection(b, fy, q));
      const totals = {};
      list.forEach(b=> totals[b.category] = (totals[b.category]||0) + parseNum(b.amount));
      const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]);

      catTotals.innerHTML = '';
      if (!entries.length){ catFilterHint.style.display='none'; return; }

      entries.forEach(([cat, total])=>{
        const tile = document.createElement('div');
        tile.className = 'k clickable';
        tile.innerHTML = `<div class="label">${categoryIcon(cat)} ${cat}</div><div class="value">${fmtAUD(total)}</div>`;
        tile.addEventListener('click', ()=>{
          if (currentCatFilter === cat) {
            currentCatFilter = null;
            catFilterHint.style.display='none';
          } else {
            currentCatFilter = cat;
            catFilterHint.textContent = `Filter active: ${cat} ‚Äî click the same total again to clear`;
            catFilterHint.style.display='block';
          }
          renderTable();
        });
        catTotals.appendChild(tile);
      });
    }

    function renderStress(){
      const list = filtered().filter(b=>!b.paid);
      const overdue = list.filter(b=>statusOf(b)==='OVERDUE').length;
      const soon = list.filter(b=>statusOf(b)==='SOON').length;
      const thisMonth = list.filter(b=>{
        const d = new Date(b.dueDate);
        const now = new Date();
        return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth();
      }).length;

      const total = list.length || 1;
      const scoreRaw = (overdue*3 + soon*2 + Math.max(0, total - overdue - soon)*0.5);
      const normalized = Math.min(100, Math.round((scoreRaw / (total*3)) * 100));
      const angle = Math.round(normalized * 1.8); // 0..180

      needle.style.transform = `rotate(${angle}deg)`;

      let title='Calm', desc='You‚Äôre in a good place. Keep cruising.', emoji='üôÇ';
      if (normalized>80){ title='Critical'; desc='High pressure. Prioritise overdue items first.'; emoji='üò¨'; }
      else if (normalized>50){ title='Stressed'; desc='Tight window. A couple of focused payments will help.'; emoji='üòü'; }
      else if (normalized>20){ title='Watch'; desc='Some bills are approaching. Plan a quick sweep.'; emoji='üòê'; }

      kOverdue.textContent = `${overdue} overdue`;
      kSoon.textContent = `${soon} due soon`;
      kThisMonth.textContent = `${thisMonth} this month`;
      stressTitle.textContent = title;
      stressDesc.textContent = desc;
      mood.textContent = emoji;
    }

    function refreshAll(){
      renderCatList();
      renderCategoryTotals();
      renderTable();
      renderStress();
    }

    // ---------- Add/Edit/Delete ----------
    function openAdd(){
      editId = null;
      modalTitle.textContent = 'Add Bill';
      fName.value = '';
      fCategory.value = '';
      fAmount.value = '';
      fDueDate.value = toISO(new Date());
      fRequired.value = 'true';
      fPaid.checked = false;
      fPaidDate.value = '';
      fPaidBy.value = '';
      fNotes.value = '';
      deleteBillBtn.style.display = 'none';
      if (typeof modal.showModal === 'function') modal.showModal(); else modal.setAttribute('open','');
    }
    function openEdit(id){
      const b = data.bills.find(x=>x.id===id);
      if (!b) return;
      editId = id;
      modalTitle.textContent = 'Edit Bill';
      fName.value = b.name || '';
      fCategory.value = b.category || '';
      fAmount.value = b.amount || '';
      fDueDate.value = toISO(b.dueDate);
      fRequired.value = b.required ? 'true' : 'false';
      fPaid.checked = !!b.paid;
      fPaidDate.value = b.paidDate ? toISO(b.paidDate) : '';
      fPaidBy.value = b.paidBy || '';
      fNotes.value = b.notes || '';
      deleteBillBtn.style.display = 'inline-flex';
      if (typeof modal.showModal === 'function') modal.showModal(); else modal.setAttribute('open','');
    }
    function saveCurrent(){
      const payload = {
        name: fName.value.trim(),
        category: fCategory.value.trim() || 'Other',
        amount: parseNum(fAmount.value),
        required: fRequired.value === 'true',
        dueDate: toISO(fDueDate.value),
        paid: !!fPaid.checked,
        paidDate: fPaidDate.value ? toISO(fPaidDate.value) : '',
        paidBy: fPaidBy.value.trim(),
        notes: fNotes.value.trim()
      };
      if (!payload.name || !payload.dueDate || !Number.isFinite(payload.amount)) {
        alert('Please fill name, due date, and a valid amount.');
        return;
      }
      if (editId){
        const idx = data.bills.findIndex(b=>b.id===editId);
        if (idx>=0) data.bills[idx] = { ...data.bills[idx], ...
