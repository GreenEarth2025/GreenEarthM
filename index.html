<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>Canberra Family Bill Tracker (Australian FY)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121823;
      --muted: #93a1b3;
      --text: #e6edf3;
      --primary: #5dd3ff;
      --accent: #87ffa3;
      --warn: #ffd66b;
      --danger: #ff7b7b;
      --ok: #7dffa0;
      --info: #74b9ff;
      --grid: rgba(255,255,255,0.06);
      --chip: rgba(255,255,255,0.06);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f7fb;
        --panel: #ffffff;
        --muted: #5f6b7a;
        --text: #111826;
        --primary: #0076de;
        --accent: #0ea86b;
        --warn: #b76e00;
        --danger: #bb1e1e;
        --ok: #0f8b3a;
        --info: #1460c8;
        --grid: rgba(0,0,0,0.06);
        --chip: rgba(0,0,0,0.06);
        --shadow: 0 10px 30px rgba(33,33,33,0.08);
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(93,211,255,0.09), transparent 60%),
        radial-gradient(1100px 600px at 110% 10%, rgba(135,255,163,0.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.02), transparent 40%),
        var(--bg);
    }
    header{
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--grid);
    }
    .wrap{ max-width: 1150px; margin: 0 auto; padding: 18px 18px; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .grow{ flex:1; min-width: 220px; }
    h1{
      margin:0;
      font-size: 20px;
      letter-spacing: 0.2px;
      display:flex; align-items:center; gap:10px;
    }
    .sub{ color: var(--muted); font-weight: 500; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
      border-radius: 999px; background: var(--chip); color: var(--muted);
      border: 1px dashed var(--grid);
    }
    select, input[type="date"], input[type="text"], input[type="number"], textarea{
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--grid);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
      box-shadow: none;
      transition: border-color .2s, background .2s;
      width: 100%;
    }
    select:focus, input:focus, textarea:focus{ border-color: var(--primary); }
    .btn{
      background: linear-gradient(180deg, color-mix(in oklab, var(--primary) 22%, transparent), transparent);
      color: var(--text);
      border: 1px solid var(--grid);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      display:inline-flex; gap:8px; align-items:center;
      transition: transform .06s ease, border-color .2s, background .2s;
      user-select: none;
    }
    .btn:hover{ border-color: color-mix(in oklab, var(--primary) 50%, var(--grid)); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: color-mix(in oklab, var(--primary) 24%, transparent); border-color: color-mix(in oklab, var(--primary) 55%, var(--grid)); }
    .btn.warn{ background: color-mix(in oklab, var(--warn) 18%, transparent); border-color: color-mix(in oklab, var(--warn) 55%, var(--grid)); }
    .btn.ghost{ background: var(--panel); }
    .grid{
      display:grid; grid-template-columns: 1.2fr 1fr; gap: 16px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      background: var(--panel);
      border: 1px solid var(--grid);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card > .h{
      padding: 14px 16px; border-bottom: 1px solid var(--grid);
      display:flex; justify-content: space-between; align-items: center; gap: 12px;
    }
    .card > .b{ padding: 14px 16px; }
    .meter{
      display:flex; align-items:center; gap: 16px;
    }
    .gauge{
      width: 120px; height: 120px; border-radius: 50%;
      background: conic-gradient(var(--ok) 0deg, var(--ok) 90deg, var(--warn) 180deg, var(--danger) 270deg, var(--danger) 360deg);
      display:grid; place-items:center; position:relative;
      box-shadow: inset 0 0 0 10px rgba(0,0,0,0.06);
    }
    .gauge::after{
      content:"";
      position:absolute; inset: 10px;
      border-radius: 50%;
      background: var(--panel);
      border: 1px solid var(--grid);
    }
    .needle{
      position: absolute; width: 3px; height: 52px;
      background: var(--text);
      transform-origin: bottom center;
      bottom: 50%; left: calc(50% - 1.5px);
      border-radius: 3px;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));
    }
    .gemoji{
      position:absolute; inset: 26px;
      display:grid; place-items:center; font-size: 28px;
      z-index: 2;
    }
    .meter .info{ display:flex; flex-direction:column; gap:6px; }
    .meter .info .title{ font-weight: 700; }
    .meter .row{ gap:10px; }
    .chip{ padding:6px 10px; border-radius: 999px; background: var(--chip); border: 1px solid var(--grid); }
    .kpi{
      display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    }
    @media (max-width: 700px){ .kpi{ grid-template-columns: repeat(2, 1fr); } }
    .k{
      background: var(--panel); border: 1px solid var(--grid); border-radius: 12px; padding: 12px;
      display:flex; flex-direction:column; gap:6px; min-height: 86px;
    }
    .k .label{ color: var(--muted); }
    .k .value{ font-size: 20px; font-weight: 700; letter-spacing: .2px; }
    .k .subv{ color: var(--muted); font-size: 12px; }
    table{
      width:100%; border-collapse: separate; border-spacing: 0 8px;
    }
    thead th{
      text-align:left; padding: 6px 8px; color: var(--muted); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px;
      user-select:none; cursor:pointer;
    }
    tbody td{
      background: var(--panel); border-top: 1px solid var(--grid); border-bottom: 1px solid var(--grid);
      padding: 10px 10px; vertical-align: middle;
    }
    tbody tr{ --stripe: transparent; }
    tbody tr td:first-child{
      border-left: 6px solid var(--stripe); border-top-left-radius: 10px; border-bottom-left-radius: 10px;
    }
    tbody tr td:last-child{ border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
    .status{ display:inline-flex; align-items:center; gap:6px; }
    .status .dot{ width:10px; height:10px; border-radius:999px; }
    .s-overdue{ --stripe: color-mix(in oklab, var(--danger) 75%, transparent); }
    .s-soon{ --stripe: color-mix(in oklab, var(--warn) 75%, transparent); }
    .s-ok{ --stripe: color-mix(in oklab, var(--accent) 75%, transparent); }
    .s-paid{ --stripe: color-mix(in oklab, var(--ok) 80%, transparent); opacity: 0.85; }
    .money{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    .center{ text-align:center; color: var(--muted); }
    .toolbar{ display:flex; flex-wrap: wrap; gap: 10px; }
    .sep{ height:1px; background: var(--grid); margin: 8px 0; }
    .footnote{ color: var(--muted); font-size: 12px; }
    .legend{ display:flex; flex-wrap: wrap; gap:10px; }
    .legend .l{ display:flex; align-items:center; gap:8px; }
    .color{ width:12px; height:12px; border-radius:3px; }
    canvas{ width:100%; height: 220px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius: 8px; border:1px solid var(--grid); }
    .right{ text-align:right; }
    /* Modal */
    dialog{
      border: none; padding:0; border-radius: 14px; width: min(720px, calc(100vw - 28px)); background: var(--panel); color: var(--text); box-shadow: var(--shadow);
    }
    dialog::backdrop{ background: rgba(0,0,0,.4); backdrop-filter: blur(2px); }
    .modal-h{ padding: 14px 16px; border-bottom: 1px solid var(--grid); font-weight: 700; display:flex; align-items:center; justify-content: space-between; }
    .modal-b{ padding: 14px 16px; display:grid; gap:12px; }
    .modal-f{ padding: 12px 16px; border-top: 1px solid var(--grid); display:flex; justify-content: space-between; gap: 10px; }
    .form-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .form-grid-3{ display:grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; }
    @media (max-width: 680px){ .form-grid, .form-grid-3{ grid-template-columns: 1fr; } }
    label{ display:flex; flex-direction:column; gap:8px; }
    .muted{ color: var(--muted); }
    .switch{ display:flex; align-items:center; gap: 8px; }
    input[type="checkbox"]{ width: 18px; height: 18px; }
    .danger{ color: var(--danger); }
    .success{ color: var(--accent); }
    /* Print styles */
    @media print{
      header, .toolbar, .no-print, dialog { display:none !important; }
      body{ background: #fff; color: #000; }
      .card, .k, .b, .h{ box-shadow: none; border: 1px solid #ccc; }
      .legend, canvas{ break-inside: avoid; }
      .wrap{ max-width: 100%; padding: 0; }
    }
    /* Confetti */
    .confetti{ position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 1000; }
    .confetti i{
      position: absolute; top:-10px; width:8px; height:14px; background: red; opacity: .85; border-radius:2px;
      animation: fall linear var(--t) forwards;
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(540deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="grow">
          <h1>Canberra P Mopuri Family Bill Tracker <span class="sub">(Australian FY)</span></h1>
          <div class="sub">Q1 = Jul–Sep, Q2 = Oct–Dec, Q3 = Jan–Mar, Q4 = Apr–Jun</div>
        </div>
        <div class="row">
          <label class="pill" title="Financial Year start">
            <span>FY start:</span>
            <select id="fyYear"></select>
          </label>
          <label class="pill" title="Financial Year quarter">
            <span>Quarter:</span>
            <select id="quarter">
              <option value="Q1">Q1 (Jul–Sep)</option>
              <option value="Q2">Q2 (Oct–Dec)</option>
              <option value="Q3">Q3 (Jan–Mar)</option>
              <option value="Q4">Q4 (Apr–Jun)</option>
              <option value="ALL">All</option>
            </select>
          </label>
          <span class="pill" id="today"></span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px;">
    <div class="toolbar no-print" style="margin-bottom:12px;">
      <button class="btn primary" id="addBtn">➕ Add New Bill</button>
      <button class="btn" id="exportBtn">⬇️ Export</button>
      <button class="btn" id="importBtn">⬆️ Import</button>
      <button class="btn warn" id="pdfBtn">🖨️ Generate PDF Summary</button>
      <span class="pill">Currency: AUD</span>
    </div>

    <section class="grid">
      <div class="card">
        <div class="h">
          <div class="row">
            <span>Bill Stress Meter</span>
          </div>
          <div class="legend">
            <div class="l"><span class="color" style="background: var(--danger)"></span><span class="muted">Overdue</span></div>
            <div class="l"><span class="color" style="background: var(--warn)"></span><span class="muted">Due soon (≤14d)</span></div>
            <div class="l"><span class="color" style="background: var(--ok)"></span><span class="muted">Clear</span></div>
          </div>
        </div>
        <div class="b meter">
          <div class="gauge" aria-label="Stress Meter Gauge">
            <div class="needle" id="needle" style="transform: rotate(0deg);"></div>
            <div class="gemoji" id="mood">🙂</div>
          </div>
          <div class="info">
            <div class="title" id="stressTitle">Calm</div>
            <div class="muted" id="stressDesc">You’re in a good place. Keep cruising.</div>
            <div class="row">
              <span class="chip" id="kOverdue">0 overdue</span>
              <span class="chip" id="kSoon">0 due soon</span>
              <span class="chip" id="kThisMonth">0 this month</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h">
          <span>Quarter snapshot</span>
        </div>
        <div class="b">
          <div class="kpi">
            <div class="k">
              <div class="label">Total bills</div>
              <div class="value" id="kTotal">0</div>
              <div class="subv">In selected FY/quarter</div>
            </div>
            <div class="k">
              <div class="label">Outstanding</div>
              <div class="value" id="kOutstanding">0</div>
              <div class="subv">Not yet paid</div>
            </div>
            <div class="k">
              <div class="label">Amount due</div>
              <div class="value money" id="kAmountDue">$0</div>
              <div class="subv">Excludes paid</div>
            </div>
            <div class="k">
              <div class="label">Avg per month</div>
              <div class="value money" id="kAvg">$0</div>
              <div class="subv">Based on quarter</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid" style="margin-top: 16px;">
      <div class="card">
        <div class="h">
          <span>Bills</span>
          <div class="row">
            <input type="text" id="search" placeholder="Search bills..." />
            <select id="statusFilter" title="Filter by status">
              <option value="ALL">All statuses</option>
              <option value="OUTSTANDING">Outstanding</option>
              <option value="PAID">Paid</option>
              <option value="OVERDUE">Overdue</option>
              <option value="SOON">Due soon (≤14d)</option>
            </select>
            <select id="reqFilter" title="Filter by required">
              <option value="ALL">Required + Optional</option>
              <option value="REQ">Required only</option>
              <option value="OPT">Optional only</option>
            </select>
          </div>
        </div>
        <div class="b">
          <div class="footnote" style="margin-bottom:8px;">Tip: Click a column header to sort. Click a row to edit.</div>
          <div style="overflow:auto;">
            <table id="billTable" aria-label="Bills table">
              <thead>
                <tr>
                  <th data-sort="status">Status</th>
                  <th data-sort="category">Category</th>
                  <th data-sort="name">Bill</th>
                  <th class="right" data-sort="amount">Amount</th>
                  <th data-sort="required">Required</th>
                  <th data-sort="dueDate">Due date</th>
                  <th data-sort="days">Days</th>
                  <th data-sort="paid">Paid?</th>
                  <th data-sort="paidDate">Paid date</th>
                  <th data-sort="paidBy">Paid by</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="billBody">
                <tr><td class="center" colspan="11">No bills yet.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="sep"></div>
          <div class="footnote">Australian FY logic: FY starts in July. Q1 Jul–Sep, Q2 Oct–Dec, Q3 Jan–Mar, Q4 Apr–Jun.</div>
        </div>
      </div>

      <div class="card">
        <div class="h"><span>Insights</span></div>
        <div class="b" style="display:grid; gap:12px;">
          <div>
            <div class="row" style="justify-content:space-between; align-items:baseline;">
              <span class="muted">Spend by category</span>
              <span class="pill" id="catHint">Current selection</span>
            </div>
            <canvas id="catChart" width="480" height="220" aria-label="Bar chart: spend by category"></canvas>
          </div>
          <div>
            <div class="row" style="justify-content:space-between; align-items:baseline;">
              <span class="muted">Status breakdown</span>
              <span class="pill" id="statusHint">Paid vs outstanding</span>
            </div>
            <canvas id="statusChart" width="480" height="220" aria-label="Donut chart: status breakdown"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Add/Edit Modal -->
  <dialog id="billModal">
    <form method="dialog" id="billForm">
      <div class="modal-h">
        <span id="modalTitle">Add Bill</span>
        <button class="btn ghost" type="button" id="closeModal">✖</button>
      </div>
      <div class="modal-b">
        <div class="form-grid">
          <label>
            <span>Bill name</span>
            <input required type="text" id="fName" placeholder="e.g., Electricity" />
          </label>
          <label>
            <span>Category</span>
            <input required type="text" id="fCategory" placeholder="e.g., Utilities" list="catList"/>
            <datalist id="catList"></datalist>
          </label>
        </div>
        <div class="form-grid-3">
          <label>
            <span>Amount (AUD)</span>
            <input required type="number" id="fAmount" min="0" step="0.01" placeholder="0.00"/>
          </label>
          <label>
            <span>Due date</span>
            <input required type="date" id="fDueDate"/>
          </label>
          <label>
            <span>Required?</span>
            <select id="fRequired">
              <option value="true">Yes (essential)</option>
              <option value="false">No (optional)</option>
            </select>
          </label>
        </div>
        <div class="form-grid">
          <label class="switch">
            <input type="checkbox" id="fPaid"/>
            <span>Mark as paid</span>
          </label>
          <label>
            <span>Paid date</span>
            <input type="date" id="fPaidDate"/>
          </label>
        </div>
        <div class="form-grid">
          <label>
            <span>Paid by</span>
            <input type="text" id="fPaidBy" placeholder="e.g., Prakash, Partner"/>
          </label>
          <label>
            <span>Notes</span>
            <input type="text" id="fNotes" placeholder="Optional note"/>
          </label>
        </div>
      </div>
      <div class="modal-f">
        <button class="btn danger" type="button" id="deleteBill" style="display:none;">🗑️ Delete</button>
        <div>
          <button class="btn" type="button" id="markPaidBtn">✅ Mark paid</button>
          <button class="btn primary" id="saveBill">💾 Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Import Modal -->
  <dialog id="importModal">
    <div class="modal-h">
      <span>Import bills (JSON)</span>
      <button class="btn ghost" type="button" id="closeImport">✖</button>
    </div>
    <div class="modal-b">
      <textarea id="importText" rows="10" placeholder='Paste exported JSON here'></textarea>
      <div class="footnote">This will merge with existing bills. Duplicate IDs are ignored.</div>
    </div>
    <div class="modal-f">
      <span></span>
      <div>
        <button class="btn" id="doImport">Import</button>
      </div>
    </div>
  </dialog>

  <div id="confetti" class="confetti" aria-hidden="true" style="display:none;"></div>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmtAUD = v => new Intl.NumberFormat('en-AU', { style:'currency', currency:'AUD', maximumFractionDigits: 2 }).format(Number(v||0));
    const today = new Date();
    const toISO = d => d ? new Date(d).toISOString().slice(0,10) : "";
    const parseNum = v => Number.isFinite(+v) ? +v : 0;

    function getFYStartYear(date){
      const d = new Date(date);
      const m = d.getMonth(); // 0..11
      return (m >= 6) ? d.getFullYear() : d.getFullYear() - 1;
    }
    function getQuarter(date){
      const d = new Date(date); const m = d.getMonth();
      if (m>=6 && m<=8) return 'Q1';
      if (m>=9 && m<=11) return 'Q2';
      if (m>=0 && m<=2) return 'Q3';
      return 'Q4';
    }
    function withinSelection(bill, fyYearVal, qVal){
      if (qVal === 'ALL') return getFYStartYear(bill.dueDate) === fyYearVal;
      return getFYStartYear(bill.dueDate) === fyYearVal && getQuarter(bill.dueDate) === qVal;
    }
    function daysFromToday(date){
      const MS=24*60*60*1000;
      const d = new Date(toISO(date));
      const t = new Date(toISO(new Date()));
      return Math.round((d - t)/MS);
    }
    function statusOf(bill){
      if (bill.paid) return 'PAID';
      const days = daysFromToday(bill.dueDate);
      if (days < 0) return 'OVERDUE';
      if (days <= 14) return 'SOON';
      return 'OUTSTANDING';
    }
    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

    // ---------- Storage ----------
    const KEY='canberra-bills-v1';
    const store = {
      load(){
        let obj = { bills: [], cats: [] };
        try{ obj = JSON.parse(localStorage.getItem(KEY)) || obj; }catch{}
        return obj;
      },
      save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }
    };

    // ---------- State ----------
    let data = store.load();
    if (!data.bills?.length){
      // Seed with gentle starters (only if empty)
      data.bills = [
        { id: uid(), name:'Electricity', category:'Utilities', amount:210.5, required:true, paid:false, paidDate:'', paidBy:'', dueDate: toISO(new Date(today.getFullYear(), 6, 25)), notes:'ACTEWAGL' },
        { id: uid(), name:'Water', category:'Utilities', amount:95.3, required:true, paid:false, paidDate:'', paidBy:'', dueDate: toISO(new Date(today.getFullYear(), 7, 5)), notes:'Icon Water' },
        { id: uid(), name:'Internet', category:'Connectivity', amount:79, required:true, paid:true, paidDate: toISO(new Date(today.getFullYear(), 6, 10)), paidBy:'Prakash', dueDate: toISO(new Date(today.getFullYear(), 6, 10)), notes:'Aussie BB' },
        { id: uid(), name:'Rent', category:'Housing', amount:2300, required:true, paid:false, paidDate:'', paidBy:'', dueDate: toISO(new Date(today.getFullYear(), 6, 1)), notes:'' },
      ];
      store.save(data);
    }

    // ---------- Controls init ----------
    const fySel = $('#fyYear');
    const qSel = $('#quarter');
    const todayEl = $('#today');
    const yearNow = getFYStartYear(new Date());
    for (let y = yearNow-1; y <= yearNow+2; y++){
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = `FY ${y}–${String((y+1)%100).padStart(2,'0')}`;
      if (y === yearNow) opt.selected = true;
      fySel.appendChild(opt);
    }
    qSel.value = getQuarter(new Date());

    todayEl.textContent = `Today: ${new Intl.DateTimeFormat('en-AU', {weekday:'short', day:'2-digit', month:'short'}).format(new Date())}`;

    // ---------- Rendering ----------
    const tbody = $('#billBody');
    const search = $('#search');
    const statusFilter = $('#statusFilter');
    const reqFilter = $('#reqFilter');

    const kOverdue = $('#kOverdue');
    const kSoon = $('#kSoon');
    const kThisMonth = $('#kThisMonth');
    const needle = $('#needle');
    const mood = $('#mood');
    const stressTitle = $('#stressTitle');
    const stressDesc = $('#stressDesc');

    const kTotal = $('#kTotal');
    const kOutstanding = $('#kOutstanding');
    const kAmountDue = $('#kAmountDue');
    const kAvg = $('#kAvg');

    const catHint = $('#catHint');
    const statusHint = $('#statusHint');

    const catList = $('#catList');

    let sortKey = 'dueDate';
    let sortDir = 'asc';

    function currentSelection(){
      return { fy: Number(fySel.value), q: qSel.value };
    }

    function listCategories(){
      const set = new Set(data.bills.map(b => b.category).filter(Boolean));
      return Array.from(set).sort();
    }

    function refreshCatList(){
      catList.innerHTML = '';
      listCategories().forEach(c => {
        const o = document.createElement('option'); o.value=c; catList.appendChild(o);
      });
    }

    function filtered(){
      const { fy, q } = currentSelection();
      const txt = (search.value||'').trim().toLowerCase();
      const statusSel = statusFilter.value;
      const reqSel = reqFilter.value;

      return data.bills
        .filter(b => withinSelection(b, fy, q))
        .filter(b => {
          if (!txt) return true;
          return [b.name, b.category, b.paidBy, b.notes].some(x => (x||'').toLowerCase().includes(txt));
        })
        .filter(b => {
          if (statusSel === 'ALL') return true;
          const s = statusOf(b);
          if (statusSel === 'OVERDUE') return s === 'OVERDUE';
          if (statusSel === 'SOON') return s === 'SOON';
          if (statusSel === 'PAID') return s === 'PAID';
          if (statusSel === 'OUTSTANDING') return (s === 'SOON' || s === 'OUTSTANDING' || s === 'OVERDUE') && !b.paid;
          return true;
        })
        .filter(b => {
          if (reqSel === 'ALL') return true;
          if (reqSel === 'REQ') return !!b.required;
          if (reqSel === 'OPT') return !b.required;
          return true;
        });
    }

    function sortBills(list){
      const dir = sortDir === 'asc' ? 1 : -1;
      return list.sort((a,b)=>{
        const A = keyVal(a), B = keyVal(b);
        if (A < B) return -1*dir;
        if (A > B) return 1*dir;
        return 0;
      });
      function keyVal(b){
        switch (sortKey){
          case 'status': return statusOf(b);
          case 'category': return (b.category||'').toLowerCase();
          case 'name': return (b.name||'').toLowerCase();
          case 'amount': return +b.amount || 0;
          case 'required': return b.required ? 0 : 1;
          case 'dueDate': return new Date(b.dueDate).getTime();
          case 'days': return daysFromToday(b.dueDate);
          case 'paid': return b.paid ? 0 : 1;
          case 'paidDate': return b.paidDate ? new Date(b.paidDate).getTime() : Number.MAX_SAFE_INTEGER;
          case 'paidBy': return (b.paidBy||'~').toLowerCase();
          default: return new Date(b.dueDate).getTime();
        }
      }
    }

    function renderTable(){
      const list = sortBills(filtered());
      tbody.innerHTML = '';
      if (!list.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="center" colspan="11">No bills match your filters.</td>`;
        tbody.appendChild(tr);
        return;
      }
      list.forEach(b=>{
        const s = statusOf(b);
        const days = daysFromToday(b.dueDate);
        const tr = document.createElement('tr');
        tr.className = s==='PAID' ? 's-paid' : (s==='OVERDUE' ? 's-overdue' : (s==='SOON' ? 's-soon' : 's-ok'));
        const dotColor = s==='PAID' ? 'var(--ok)' : s==='OVERDUE' ? 'var(--danger)' : s==='SOON' ? 'var(--warn)' : 'var(--accent)';
        tr.innerHTML = `
          <td>
            <div class="status"><span class="dot" style="background:${dotColor}"></span> <span>${s}</span></div>
          </td>
          <td>${escapeHTML(b.category||'—')}</td>
          <td>${escapeHTML(b.name)}</td>
          <td class="right money">${fmtAUD(b.amount)}</td>
          <td>${b.required ? 'Yes' : 'No'}</td>
          <td>${toISO(b.dueDate)}</td>
          <td>${days>=0 ? days+'d' : (days+'d')}</td>
          <td>${b.paid ? 'Yes' : 'No'}</td>
          <td>${b.paidDate ? toISO(b.paidDate) : '—'}</td>
          <td>${escapeHTML(b.paidBy||'—')}</td>
          <td>
            <button class="btn" data-action="toggle" data-id="${b.id}" title="Toggle paid">${b.paid?'↩️ Unpay':'✅ Paid'}</button>
            <button class="btn" data-action="edit" data-id="${b.id}" title="Edit">✏️</button>
          </td>
        `;
        tr.addEventListener('click', (e)=>{
          if (e.target.closest('button')) return; // handled below
          openEdit(b.id);
        });
        tbody.appendChild(tr);
      });
      // Row buttons
      tbody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.currentTarget.dataset.id;
          const act = e.currentTarget.dataset.action;
          if (act === 'toggle'){
            const b = data.bills.find(x=>x.id===id);
            if (!b) return;
            b.paid = !b.paid;
            if (b.paid){ b.paidDate = toISO(new Date()); if (!b.paidBy) b.paidBy = '—'; }
            store.save(data);
            refresh();
            checkCelebration();
          } else if (act === 'edit'){
            openEdit(id);
          }
        });
      });
    }

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function computeKPIs(){
      const list = filtered();
      const outstanding = list.filter(b=>!b.paid);
      const amountDue = outstanding.reduce((a,b)=>a+parseNum(b.amount),0);
      const months = (qSel.value==='ALL') ? 12 : 3;
      kTotal.textContent = list.length;
      kOutstanding.textContent = outstanding.length;
      kAmountDue.textContent = fmtAUD(amountDue);
      kAvg.textContent = fmtAUD(amountDue / months);
    }

    function computeStress(){
      const list = filtered().filter(b=>!b.paid);
      const overdue = list.filter(b=>statusOf(b)==='OVERDUE').length;
      const soon = list.filter(b=>statusOf(b)==='SOON').length;
      const thisMonth = list.filter(b=>{
        const d = new Date(b.dueDate);
        const now = new Date();
        return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth();
      }).length;

      // Weighted score: overdue 3, soon 2, others 1 (capped)
      const total = list.length || 1;
      const scoreRaw = (overdue*3 + soon*2 + Math.max(0, total - overdue - soon)*0.5);
      const normalized = Math.min(100, Math.round((scoreRaw / (total*3)) * 100));

      let angle = Math.round(normalized * 1.8); // 0..180 degrees
      needle.style.transform = `rotate(${angle}deg)`;

      let title='Calm', desc='You’re in a good place. Keep cruising.', emoji='🙂';
      if (normalized>80){ title='Critical'; desc='High pressure. Prioritise overdue items first.'; emoji='😬'; }
      else if (normalized>50){ title='Stressed'; desc='Tight window. A couple of focused payments will help.'; emoji='😟'; }
      else if (normalized>20){ title='Watch'; desc='Some bills are approaching. Plan a quick sweep.'; emoji='😐'; }

      kOverdue.textContent = `${overdue} overdue`;
      kSoon.textContent = `${soon} due soon`;
      kThisMonth.textContent = `${thisMonth} this month`;
      stressTitle.textContent = title;
      stressDesc.textContent = desc;
      mood.textContent = emoji;
    }

    // ---------- Charts (vanilla canvas) ----------
    const catCanvas = $('#catChart');
    const statusCanvas = $('#statusChart');

    function drawCategoryChart(){
      const ctx = catCanvas.getContext('2d');
      const DPR = window.devicePixelRatio || 1;
      sizeCanvas(catCanvas, DPR);

      const list = filtered();
      const byCat = Object.create(null);
      list.forEach(b=>{
        const key
